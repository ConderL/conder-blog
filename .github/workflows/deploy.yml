name: 生产环境发布

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: 20
  PNPM_VERSION: 10.10.0

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置Node.js环境
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: 安装PNPM
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: 配置PNPM缓存
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: 安装依赖
        run: pnpm install --frozen-lockfile

      - name: 应用构建
        env:
          OXC_DISABLE: 1
          NODE_OPTIONS: --max-old-space-size=4096
        run: |
          cd packages/blog-nest && pnpm build
          cd ../blog-nuxt && pnpm build
          cd ../blog-admin && pnpm build

      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: 构建Docker镜像
        run: |
          docker build -f docker/blog-nest.Dockerfile -t blog-nest:latest .
          docker build -f docker/blog-nuxt.Dockerfile -t blog-nuxt:latest .
          docker build -f docker/blog-admin.Dockerfile -t blog-admin:latest .

      - name: 保存镜像为tar文件
        run: |
          docker save blog-nest:latest | gzip > blog-nest.tar.gz
          docker save blog-nuxt:latest | gzip > blog-nuxt.tar.gz
          docker save blog-admin:latest | gzip > blog-admin.tar.gz

      - name: 传输镜像到服务器
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "*.tar.gz"
          target: ${{ secrets.SERVER_DEPLOY_PATH }}/

      - name: 部署到服务器
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          command_timeout: 30m
          script: |
            set -exo pipefail
            cd ${{ secrets.SERVER_DEPLOY_PATH }}

            # 同步代码
            git fetch --all
            git reset --hard origin/main

            # 创建环境变量
            cat > .env << 'EOF'
            DB_HOST=mysql
            DB_PORT=3306
            DB_DATABASE=${{ secrets.DB_DATABASE }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            REDIS_HOST=redis
            REDIS_PORT=6379
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
            EOF

            # 创建后端环境变量
            cat > packages/blog-nest/.env << 'EOF'
            FRONTEND_URL=https://conder.top
            PORT=3000
            DB_HOST=mysql
            DB_PORT=3306
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_DATABASE=${{ secrets.DB_DATABASE }}
            NGINX_PORT=80
            NGINX_DOMAIN=localhost
            REDIS_HOST=redis
            REDIS_PORT=6379
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_EXPIRES_IN=7d
            MAIL_HOST=${{ secrets.MAIL_HOST }}
            MAIL_PORT=${{ secrets.MAIL_PORT }}
            MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
            MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
            OAUTH_GITHUB_CLIENT_ID=${{ secrets.OAUTH_GITHUB_CLIENT_ID }}
            OAUTH_GITHUB_CLIENT_SECRET=${{ secrets.OAUTH_GITHUB_CLIENT_SECRET }}
            OAUTH_GITHUB_REDIRECT_URL=${{ secrets.OAUTH_GITHUB_REDIRECT_URL }}
            OAUTH_GITEE_CLIENT_ID=${{ secrets.OAUTH_GITEE_CLIENT_ID }}
            OAUTH_GITEE_CLIENT_SECRET=${{ secrets.OAUTH_GITEE_CLIENT_SECRET }}
            OAUTH_GITEE_REDIRECT_URL=${{ secrets.OAUTH_GITEE_REDIRECT_URL }}
            OAUTH_QQ_APP_ID=${{ secrets.OAUTH_QQ_APP_ID }}
            OAUTH_QQ_APP_KEY=${{ secrets.OAUTH_QQ_APP_KEY }}
            OAUTH_QQ_REDIRECT_URL=${{ secrets.OAUTH_QQ_REDIRECT_URL }}
            SEARCH_MODE=mysql
            ELASTICSEARCH_USERNAME=elastic
            ELASTICSEARCH_PASSWORD=${{ secrets.ELASTICSEARCH_PASSWORD }}
            ELASTICSEARCH_HOSTNAME=localhost
            ELASTICSEARCH_PORT=9200
            UPLOAD_STRATEGY=oss
            OSS_ACCESS_KEY_ID=${{ secrets.OSS_ACCESS_KEY_ID }}
            OSS_ACCESS_KEY_SECRET=${{ secrets.OSS_ACCESS_KEY_SECRET }}
            OSS_REGION=${{ secrets.OSS_REGION }}
            OSS_BUCKET=${{ secrets.OSS_BUCKET }}
            OSS_ENDPOINT=${{ secrets.OSS_ENDPOINT }}
            OSS_CDN_URL=${{ secrets.OSS_CDN_URL }}
            BAIDU_API_KEY=${{ secrets.BAIDU_API_KEY }}
            BAIDU_SECRET_KEY=${{ secrets.BAIDU_SECRET_KEY }}
            RSA_PRIVATE_KEY=${{ secrets.RSA_PRIVATE_KEY }}
            DIFY_API_KEY=${{ secrets.DIFY_API_KEY }}
            EOF

            # 停止旧容器
            docker compose down --remove-orphans --timeout 30

            # 加载新镜像
            docker load < blog-nest.tar.gz
            docker load < blog-nuxt.tar.gz
            docker load < blog-admin.tar.gz

            # 标记镜像
            docker tag blog-nest:latest ${{ secrets.DOCKERHUB_USERNAME }}/blog-nest:latest
            docker tag blog-nuxt:latest ${{ secrets.DOCKERHUB_USERNAME }}/blog-nuxt:latest
            docker tag blog-admin:latest ${{ secrets.DOCKERHUB_USERNAME }}/blog-admin:latest

            # 启动数据库
            docker compose up -d mysql redis

            # 等待数据库就绪
            echo "等待数据库启动..."
            for i in {1..20}; do
              if docker compose exec mysql mysqladmin ping -h localhost --silent 2>/dev/null; then
                echo "MySQL 已就绪"
                break
              fi
              echo "等待 MySQL... 尝试 $i/20"
              sleep 10
            done

            # 启动应用
            docker compose up -d nest nuxt admin nginx

            # 清理tar文件和旧镜像
            rm -f *.tar.gz
            docker image prune -a -f --filter "until=24h"

            # 健康检查
            sleep 10
            docker compose ps
